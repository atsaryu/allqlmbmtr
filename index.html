<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan Excel Modern</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --sticky-bg: #ffffff;
            --cell-hover: #f1f5f9;
        }

        .dark-mode {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f3f4f6;
            --border-color: #374151;
            --primary: #60a5fa;
            --sticky-bg: #1f2937;
            --cell-hover: #374151;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: 0.3s; }

        /* Header & Controls */
        header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        select, button { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; }
        button.primary { background: var(--primary); color: white; border: none; }
        button.danger { background: var(--danger); color: white; border: none; }
        
        /* Summary Cards */
        .summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { margin: 0; font-size: 14px; opacity: 0.7; }
        .card p { margin: 5px 0 0; font-size: 18px; font-weight: bold; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* Table Area */
        .table-wrapper { overflow-x: auto; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; max-height: 70vh; }
        table { border-collapse: collapse; width: 100%; font-size: 13px; }
        
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: center; white-space: nowrap; }
        
        /* Sticky Column & Header */
        th { background: var(--bg-color); position: sticky; top: 0; z-index: 10; color: var(--text-color); }
        .sticky-col { position: sticky; left: 0; background: var(--sticky-bg); z-index: 5; border-right: 2px solid var(--border-color); min-width: 120px; text-align: left; font-weight: 600; cursor: pointer; }
        th.sticky-col { z-index: 20; } /* Corner cell */

        /* Date Columns */
        th.date-col { min-width: 40px; font-size: 11px; }
        td.cell-data { cursor: pointer; min-width: 40px; }
        td.cell-data:hover { background-color: var(--cell-hover); }
        
        /* Cell Content (Mini Indicators) */
        .val-inc { color: var(--success); font-size: 10px; display: block; }
        .val-exp { color: var(--danger); font-size: 10px; display: block; }
        
        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; position: relative; }
        .modal-header { font-weight: bold; margin-bottom: 15px; font-size: 18px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 12px; }
        .form-group input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); }
        .close-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; }

        /* Chart Section */
        #chartsModal .modal-content { max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .chart-box { margin-bottom: 30px; height: 300px; }

        /* Utilities */
        .hidden { display: none; }
        @media (max-width: 600px) {
            .controls { width: 100%; justify-content: space-between; }
            .summary-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <h2>üìí KeuanganSheet</h2>
    <div class="controls">
        <select id="selMonth"></select>
        <select id="selYear"></select>
        <button onclick="toggleDarkMode()">üåô Mode</button>
        <button class="primary" onclick="openNameModal()">+ Nama</button>
        <button onclick="openCharts()">üìä Grafik</button>
        <button class="danger" onclick="resetData()">‚ö† Reset</button>
    </div>
</header>

<div class="summary-container">
    <div class="card">
        <h3>Pemasukan</h3>
        <p class="text-green" id="dispIncome">0</p>
    </div>
    <div class="card">
        <h3>Pengeluaran</h3>
        <p class="text-red" id="dispExpense">0</p>
    </div>
    <div class="card">
        <h3>Total Saldo</h3>
        <p id="dispBalance">0</p>
    </div>
</div>

<div class="table-wrapper">
    <table id="mainTable">
        <thead>
            <tr id="headerRow">
                </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
        <tfoot id="tableFoot">
            </tfoot>
    </table>
</div>

<div id="inputModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('inputModal')">&times;</button>
        <div class="modal-header">Edit Data</div>
        <div style="margin-bottom: 10px; font-size: 14px; opacity: 0.8;" id="modalInfo"></div>
        
        <div class="form-group">
            <label>Pemasukan (Income)</label>
            <input type="number" id="inpIncome" placeholder="0">
        </div>
        <div class="form-group">
            <label>Pengeluaran (Expense)</label>
            <input type="number" id="inpExpense" placeholder="0">
        </div>
        <button class="primary" style="width: 100%" onclick="saveTransaction()">Simpan</button>
    </div>
</div>

<div id="nameModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('nameModal')">&times;</button>
        <div class="modal-header" id="nameModalTitle">Tambah Nama</div>
        <input type="hidden" id="editNameId">
        <div class="form-group">
            <label>Nama Anggota / Kategori</label>
            <input type="text" id="inpName" placeholder="Contoh: Budi, Belanja, Listrik">
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="primary" style="flex: 1" onclick="saveName()">Simpan</button>
            <button id="btnDeleteName" class="danger hidden" onclick="deleteName()">Hapus</button>
        </div>
    </div>
</div>

<div id="chartsModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('chartsModal')">&times;</button>
        <div class="modal-header">Laporan Visual</div>
        
        <div class="chart-box">
            <canvas id="chartPerName"></canvas>
        </div>
        <hr>
        <div class="chart-box">
            <canvas id="chartMonthly"></canvas>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    const DB_KEY = 'finance_excel_v2';
    let dataStore = {
        names: [], // Array of {id, name}
        records: {} // Format: { year: { month: { nameId: { day: { inc: 0, exp: 0 } } } } }
    };
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedNameId = null;
    let selectedDay = null;

    // --- INITIALIZATION ---
    function init() {
        loadData();
        setupSelectors();
        renderTable();
        updateSummary();
    }

    function loadData() {
        const saved = localStorage.getItem(DB_KEY);
        if (saved) {
            dataStore = JSON.parse(saved);
        } else {
            // Data Dummy Awal
            dataStore.names = [
                { id: 'n1', name: 'Ayah' },
                { id: 'n2', name: 'Ibu' },
                { id: 'n3', name: 'Operasional' }
            ];
        }
    }

    function saveData() {
        localStorage.setItem(DB_KEY, JSON.stringify(dataStore));
        renderTable();
        updateSummary();
    }

    function setupSelectors() {
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const selMonth = document.getElementById('selMonth');
        const selYear = document.getElementById('selYear');

        months.forEach((m, i) => {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = m;
            if(i === currentMonth) opt.selected = true;
            selMonth.add(opt);
        });

        for(let y = 2023; y <= 2030; y++) {
            let opt = document.createElement('option');
            opt.value = y;
            opt.text = y;
            if(y === currentYear) opt.selected = true;
            selYear.add(opt);
        }

        selMonth.addEventListener('change', (e) => { currentMonth = parseInt(e.target.value); renderTable(); updateSummary(); });
        selYear.addEventListener('change', (e) => { currentYear = parseInt(e.target.value); renderTable(); updateSummary(); });
    }

    // --- RENDERING TABLE ---
    function renderTable() {
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const headerRow = document.getElementById('headerRow');
        const tableBody = document.getElementById('tableBody');
        const tableFoot = document.getElementById('tableFoot');

        // 1. Build Header
        let htmlHeader = `<th class="sticky-col">Nama</th>`;
        for(let d=1; d<=daysInMonth; d++) {
            htmlHeader += `<th class="date-col">${d}</th>`;
        }
        htmlHeader += `<th>Total</th>`;
        headerRow.innerHTML = htmlHeader;

        // 2. Build Rows (Names)
        let htmlBody = '';
        let colTotalsInc = new Array(daysInMonth + 1).fill(0);
        let colTotalsExp = new Array(daysInMonth + 1).fill(0);

        dataStore.names.forEach(person => {
            let rowTotalInc = 0;
            let rowTotalExp = 0;
            
            htmlBody += `<tr>`;
            // Sticky Name Column (Clickable for edit)
            htmlBody += `<td class="sticky-col" onclick="editName('${person.id}')">${person.name} <small style="float:right; opacity:0.5">‚úèÔ∏è</small></td>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const rec = getRecord(currentYear, currentMonth, person.id, d);
                let content = '';
                if(rec.inc > 0) content += `<span class="val-inc">+${formatK(rec.inc)}</span>`;
                if(rec.exp > 0) content += `<span class="val-exp">-${formatK(rec.exp)}</span>`;
                
                rowTotalInc += rec.inc || 0;
                rowTotalExp += rec.exp || 0;
                colTotalsInc[d] += rec.inc || 0;
                colTotalsExp[d] += rec.exp || 0;

                htmlBody += `<td class="cell-data" onclick="openInputModal('${person.id}', ${d})">${content}</td>`;
            }
            
            const net = rowTotalInc - rowTotalExp;
            let color = net >= 0 ? 'text-green' : 'text-red';
            htmlBody += `<td style="font-weight:bold" class="${color}">${formatNum(net)}</td>`;
            htmlBody += `</tr>`;
        });
        tableBody.innerHTML = htmlBody;

        // 3. Build Footer (Totals per date)
        let htmlFoot = `<tr><td class="sticky-col">TOTAL</td>`;
        let grandTotal = 0;
        for(let d=1; d<=daysInMonth; d++) {
            const netDay = colTotalsInc[d] - colTotalsExp[d];
            grandTotal += netDay;
            let color = netDay >= 0 ? 'text-green' : 'text-red';
            // Show dot if 0 to save space, or number if value exists
            let display = netDay !== 0 ? formatK(netDay) : '-';
            htmlFoot += `<td style="font-size:10px; font-weight:bold; color:${netDay<0?'red':'green'}">${display}</td>`;
        }
        htmlFoot += `<td>${formatNum(grandTotal)}</td></tr>`;
        tableFoot.innerHTML = htmlFoot;
    }

    // --- DATA HELPERS ---
    function getRecord(y, m, id, d) {
        try {
            return dataStore.records[y][m][id][d] || { inc: 0, exp: 0 };
        } catch(e) {
            return { inc: 0, exp: 0 };
        }
    }

    function setRecord(y, m, id, d, inc, exp) {
        if(!dataStore.records[y]) dataStore.records[y] = {};
        if(!dataStore.records[y][m]) dataStore.records[y][m] = {};
        if(!dataStore.records[y][m][id]) dataStore.records[y][m][id] = {};
        
        dataStore.records[y][m][id][d] = { inc: parseFloat(inc) || 0, exp: parseFloat(exp) || 0 };
    }

    function updateSummary() {
        let totalInc = 0;
        let totalExp = 0;
        
        // Loop through current month data only
        const monthData = dataStore.records[currentYear]?.[currentMonth];
        if(monthData) {
            Object.values(monthData).forEach(personData => {
                Object.values(personData).forEach(dayData => {
                    totalInc += dayData.inc || 0;
                    totalExp += dayData.exp || 0;
                });
            });
        }

        document.getElementById('dispIncome').innerText = formatNum(totalInc);
        document.getElementById('dispExpense').innerText = formatNum(totalExp);
        document.getElementById('dispBalance').innerText = formatNum(totalInc - totalExp);
    }

    // --- MODAL FUNCTIONS ---
    function openInputModal(personId, day) {
        selectedNameId = personId;
        selectedDay = day;
        
        const person = dataStore.names.find(n => n.id === personId);
        const rec = getRecord(currentYear, currentMonth, personId, day);
        
        document.getElementById('modalInfo').innerText = `${person.name} - Tanggal ${day}`;
        document.getElementById('inpIncome').value = rec.inc === 0 ? '' : rec.inc;
        document.getElementById('inpExpense').value = rec.exp === 0 ? '' : rec.exp;
        
        document.getElementById('inputModal').style.display = 'flex';
        document.getElementById('inpIncome').focus();
    }

    function saveTransaction() {
        const inc = document.getElementById('inpIncome').value;
        const exp = document.getElementById('inpExpense').value;
        
        setRecord(currentYear, currentMonth, selectedNameId, selectedDay, inc, exp);
        saveData();
        closeModal('inputModal');
    }

    function openNameModal() {
        document.getElementById('nameModalTitle').innerText = "Tambah Nama";
        document.getElementById('inpName').value = "";
        document.getElementById('editNameId').value = "";
        document.getElementById('btnDeleteName').classList.add('hidden');
        document.getElementById('nameModal').style.display = 'flex';
    }

    function editName(id) {
        const person = dataStore.names.find(n => n.id === id);
        document.getElementById('nameModalTitle').innerText = "Edit Nama";
        document.getElementById('inpName').value = person.name;
        document.getElementById('editNameId').value = id;
        document.getElementById('btnDeleteName').classList.remove('hidden');
        document.getElementById('nameModal').style.display = 'flex';
    }

    function saveName() {
        const nameVal = document.getElementById('inpName').value;
        const idVal = document.getElementById('editNameId').value;
        
        if(!nameVal) return alert("Nama tidak boleh kosong");

        if(idVal) {
            // Edit existing
            const idx = dataStore.names.findIndex(n => n.id === idVal);
            if(idx !== -1) dataStore.names[idx].name = nameVal;
        } else {
            // New
            const newId = 'n' + Date.now();
            dataStore.names.push({ id: newId, name: nameVal });
        }
        saveData();
        closeModal('nameModal');
    }

    function deleteName() {
        const idVal = document.getElementById('editNameId').value;
        if(confirm("Hapus nama ini? Data keuangannya akan tetap tersimpan tapi nama hilang dari tabel.")) {
            dataStore.names = dataStore.names.filter(n => n.id !== idVal);
            saveData();
            closeModal('nameModal');
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // --- CHARTS ---
    let chartNameInstance = null;
    let chartMonthlyInstance = null;

    function openCharts() {
        document.getElementById('chartsModal').style.display = 'flex';
        renderCharts();
    }

    function renderCharts() {
        // 1. Chart Per Nama (Bulan Ini)
        const ctxName = document.getElementById('chartPerName').getContext('2d');
        const labels = [];
        const dataInc = [];
        const dataExp = [];

        dataStore.names.forEach(p => {
            labels.push(p.name);
            let pInc = 0, pExp = 0;
            const pData = dataStore.records[currentYear]?.[currentMonth]?.[p.id];
            if(pData) {
                Object.values(pData).forEach(v => { pInc += v.inc; pExp += v.exp; });
            }
            dataInc.push(pInc);
            dataExp.push(pExp);
        });

        if(chartNameInstance) chartNameInstance.destroy();
        chartNameInstance = new Chart(ctxName, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Pemasukan', data: dataInc, backgroundColor: '#10b981' },
                    { label: 'Pengeluaran', data: dataExp, backgroundColor: '#ef4444' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Perbandingan Per Nama (Bulan Ini)' } } }
        });

        // 2. Chart Tahunan (Jan-Des)
        const ctxMonth = document.getElementById('chartMonthly').getContext('2d');
        const mLabels = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
        const mInc = new Array(12).fill(0);
        const mExp = new Array(12).fill(0);

        if(dataStore.records[currentYear]) {
            Object.entries(dataStore.records[currentYear]).forEach(([mIndex, monthData]) => {
                let sumInc = 0, sumExp = 0;
                Object.values(monthData).forEach(pData => {
                    Object.values(pData).forEach(v => { sumInc += v.inc; sumExp += v.exp; });
                });
                mInc[mIndex] = sumInc;
                mExp[mIndex] = sumExp;
            });
        }

        if(chartMonthlyInstance) chartMonthlyInstance.destroy();
        chartMonthlyInstance = new Chart(ctxMonth, {
            type: 'line',
            data: {
                labels: mLabels,
                datasets: [
                    { label: 'Pemasukan', data: mInc, borderColor: '#10b981', tension: 0.3 },
                    { label: 'Pengeluaran', data: mExp, borderColor: '#ef4444', tension: 0.3 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Trend Bulanan Tahun ${currentYear}` } } }
        });
    }

    // --- UTILS ---
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
    }

    function resetData() {
        if(confirm("Hapus SEMUA data? Tidak bisa dikembalikan!")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }

    // Format number to Rupiah like
    function formatNum(n) {
        return new Intl.NumberFormat('id-ID').format(n);
    }

    // Format number to "10k", "1.5j" for small cells
    function formatK(n) {
        if(n >= 1000000) return (n/1000000).toFixed(1) + 'j';
        if(n >= 1000) return (n/1000).toFixed(0) + 'k';
        return n;
    }

    // Start
    init();

</script>

</body>
</html>