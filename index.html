<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Keuangan Sederhana</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --danger: #ef4444;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
    }
    .container {
      padding: 12px;
      max-width: 480px;
      margin: auto;
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    select, input, button {
      background: var(--card);
      color: var(--text);
      border: 1px solid #1f2933;
      border-radius: 8px;
      padding: 8px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
    }
    button.add {
      background: var(--accent);
      color: #022c22;
      font-weight: 600;
    }
    button.danger {
      background: var(--danger);
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #1f2937;
      padding: 4px;
      text-align: center;
    }
    th {
      background: #020617;
      font-size: 11px;
    }
    .small {
      font-size: 10px;
      color: var(--muted);
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    canvas {
      max-width: 100%;
    }
  </style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
</head>
<body>
  <header>Keuangan Bulanan</header>
  <div class="container">

    <div class="controls">
      <select id="month"></select>
      <select id="year"></select>
    </div>

    <div class="card">
      <div class="controls">
        <input id="nameInput" placeholder="Nama" />
        <button class="add" onclick="addName()">Tambah Nama</button>
      </div>
      <div id="tables"></div>
    </div>

    <div class="card">
      <h4>Total & Laporan Bulanan</h4>
      <div id="summary"></div>
    </div>

    <div class="card">
      <h4>Grafik Per Nama</h4>
      <canvas id="chartName"></canvas>
    </div>

    <div class="card">
      <h4>Grafik Per Bulan (Janâ€“Des)</h4>
      <canvas id="chartMonth"></canvas>
    </div>

  </div>

<script>
const data = JSON.parse(localStorage.getItem('keuangan') || '{}');

const monthSelect = document.getElementById('month');
const yearSelect = document.getElementById('year');

const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
months.forEach((m,i)=>{
  const o=document.createElement('option');o.value=i;o.text=m;monthSelect.appendChild(o);
});

for(let y=2022;y<=2035;y++){
  const o=document.createElement('option');o.value=y;o.text=y;yearSelect.appendChild(o);
}

const now=new Date();
monthSelect.value=now.getMonth();
yearSelect.value=now.getFullYear();

function key(){return yearSelect.value+'-'+monthSelect.value}

function daysInMonth(y,m){return new Date(y, m+1, 0).getDate()}

function save(){localStorage.setItem('keuangan',JSON.stringify(data))}

function addName(){
  const n=document.getElementById('nameInput').value.trim();
  if(!n)return;
  const k=key();
  data[k]=data[k]||{};
  data[k][n]=data[k][n]||{in:{},out:{}};
  save();render();
  document.getElementById('nameInput').value='';
}

function updateVal(name,type,day,val){
  const k=key();
  data[k][name][type][day]=Number(val)||0;
  save();renderSummary();renderCharts();
}

function removeName(name){
  const k=key();
  delete data[k][name];
  save();render();
}

function render(){
  const wrap=document.getElementById('tables');
  wrap.innerHTML='';
  const k=key();
  const d=data[k]||{};
  const maxDay=daysInMonth(yearSelect.value,monthSelect.value);

  Object.keys(d).forEach(name=>{
    const card=document.createElement('div');card.className='card';
    card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <strong>${name}</strong>
      <button class="danger" onclick="removeName('${name}')">Hapus</button>
    </div>`;

    const table=document.createElement('table');
    let thead='<tr><th>Tgl</th>';
    for(let i=1;i<=maxDay;i++)thead+=`<th class="small">${i}</th>`;
    thead+='</tr>';

    let rowIn='<tr><td>Pemasukan</td>';
    let rowOut='<tr><td>Pengeluaran</td>';

    for(let i=1;i<=maxDay;i++){
      rowIn+=`<td><input type="number" value="${d[name].in[i]||''}" style="width:60px" onchange="updateVal('${name}','in',${i},this.value)"></td>`;
      rowOut+=`<td><input type="number" value="${d[name].out[i]||''}" style="width:60px" onchange="updateVal('${name}','out',${i},this.value)"></td>`;
    }
    rowIn+='</tr>';rowOut+='</tr>';
    table.innerHTML=thead+rowIn+rowOut;
    card.appendChild(table);
    wrap.appendChild(card);
  });
  renderSummary();renderCharts();
}

function renderSummary(){
  const k=key();
  const d=data[k]||{};
  let html='';
  let totalIn=0,totalOut=0;
  Object.keys(d).forEach(n=>{
    const sumIn=Object.values(d[n].in).reduce((a,b)=>a+b,0);
    const sumOut=Object.values(d[n].out).reduce((a,b)=>a+b,0);
    totalIn+=sumIn;totalOut+=sumOut;
    html+=`<div>${n}: +${sumIn} / -${sumOut} = <strong>${sumIn-sumOut}</strong></div>`;
  });
  html+=`<hr>Total Masuk: ${totalIn}<br>Total Keluar: ${totalOut}<br><strong>Saldo: ${totalIn-totalOut}</strong>`;
  document.getElementById('summary').innerHTML=html;
}

let chart1,chart2;
function renderCharts(){
  const k=key();
  const d=data[k]||{};
  const labels=Object.keys(d);
  const values=labels.map(n=>Object.values(d[n].in).reduce((a,b)=>a+b,0)-Object.values(d[n].out).reduce((a,b)=>a+b,0));

  if(chart1)chart1.destroy();
  chart1=new Chart(document.getElementById('chartName'),{
    type:'bar',data:{labels,datasets:[{data:values}]},options:{plugins:{legend:{display:false}}}
  });

  const year=yearSelect.value;
  const monthVals=months.map((m,i)=>{
    const dk=data[year+'-'+i]||{};
    return Object.values(dk).reduce((t,n)=>t+(Object.values(n.in).reduce((a,b)=>a+b,0)-Object.values(n.out).reduce((a,b)=>a+b,0)),0);
  });

  if(chart2)chart2.destroy();
  chart2=new Chart(document.getElementById('chartMonth'),{
    type:'line',data:{labels:months,datasets:[{data:monthVals}]},options:{plugins:{legend:{display:false}}}
  });
}

monthSelect.onchange=render;yearSelect.onchange=render;
render();
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
